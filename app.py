import streamlit as st
import cv2
import numpy as np
from PIL import Image

# ---------------------------------------------------------
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã12è‰²ã®å®šç¾©ï¼‰
# ---------------------------------------------------------
COLOR_DB = {
    "Red": {
        "name": "ãƒ¬ãƒƒãƒ‰ (R)",
        "meaning": "è¡Œå‹•åŠ›ãƒ»æƒ…ç†±ãƒ»çµŒå–¶æ„Ÿè¦š",
        "positive": "ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æº€ã¡æº¢ã‚Œã€ç¾å®Ÿã‚’å‹•ã‹ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè»½ãã€ç¾©ç†å …ã„ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç„¡æ°—åŠ›ãƒ»ç¾å®Ÿé€ƒé¿\nçµŒæ¸ˆçš„ãªä¸å®‰ã‚„ã€åœ°ã«è¶³ãŒã¤ã„ã¦ã„ãªã„æ„Ÿè¦šãŒã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿèº«ä½“ã‚’æ¸©ã‚ã¾ã—ã‚‡ã†ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘æ€’ã‚Šãƒ»å¼·å¼•\nã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¼·ã™ãã¦ã€æ”»æ’ƒçš„ã«ãªã£ãŸã‚Šã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "é‹å‹•ã€æ•£æ­©ã€ãƒˆã‚¤ãƒ¬æƒé™¤"
    },
    "Coral": {
        "name": "ã‚³ãƒ¼ãƒ©ãƒ«ãƒ¬ãƒƒãƒ‰ (C)",
        "meaning": "æœ¬èƒ½ãƒ»æ¯æ€§ãƒ»ç¹Šç´°ã•",
        "positive": "ç›´æ„Ÿã‚„èº«ä½“æ„Ÿè¦šãŒé‹­ãã€å ´ã®ç©ºæ°—ã‚’è‚Œã§æ„Ÿã˜ã‚‹åŠ›ãŒã‚ã‚Šã¾ã™ã€‚äººã‚’è‚²ã¦ã‚‹æ¯æ€§ã‚„å„ªã—ã•ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç¥çµŒéæ•ãƒ»ä¾å­˜\nç›¸æ‰‹ã«å°½ãã—ã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿå ±ã‚ã‚Œãªã„æ€ã„ã‚’æŠ±ãˆã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»è‡ªå®¶ä¸­æ¯’\néæ•ã«ãªã‚Šã™ãã¦ã€å†…å´ã«æ¯’ã‚’æºœã‚è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å²©ç›¤æµ´ã€ãƒ¨ã‚¬ã€æ°—åŠŸ"
    },
    "Orange": {
        "name": "ã‚ªãƒ¬ãƒ³ã‚¸ (O)",
        "meaning": "æ„Ÿæƒ…ãƒ»ç¾æ„è­˜ãƒ»é£Ÿ",
        "positive": "äº”æ„ŸãŒé‹­ãã€äººç”Ÿã‚’æ¥½ã—ã‚€é”äººã§ã™ã€‚ç¾å‘³ã—ã„ã‚‚ã®ã‚„ç¾ã—ã„ã‚‚ã®ã«æ„Ÿå‹•ã™ã‚‹å¿ƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ„Ÿæƒ…ã®æŠ‘åœ§ãƒ»ä¸æ„Ÿç—‡\nãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹æ°—æŒã¡ã‚’å¿˜ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ„Ÿæƒ…çš„ãƒ»åˆºæ¿€ä¸­æ¯’\nè²·ã„ç‰©ã‚„é£Ÿãªã©ã®åˆºæ¿€ã§æº€ãŸãã†ã¨ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ãƒ€ãƒ³ã‚¹ã€æ¸©æ³‰ã€ç¾å‘³ã—ã„é£Ÿäº‹"
    },
    "Gold": {
        "name": "ã‚´ãƒ¼ãƒ«ãƒ‰ (G)",
        "meaning": "ä¿¡å¿µãƒ»ã‚«ãƒªã‚¹ãƒãƒ»ä¸­å¿ƒ",
        "positive": "æºã‚‹ããªã„ä¿¡å¿µã¨è‡ªåˆ†è»¸ã‚’æŒã£ã¦ã„ã¾ã™ã€‚çµ„ç¹”ã®ä¸­å¿ƒäººç‰©ã¨ã—ã¦ã€å­˜åœ¨æ„Ÿã ã‘ã§äººã‚’æƒ¹ãã¤ã‘ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ä¸å®‰ãƒ»è‡ªä¿¡å–ªå¤±\nã€Œè‡ªåˆ†ã«ã¯ä¾¡å€¤ãŒãªã„ã€ã¨æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘é ‘å›ºãƒ»å‚²æ…¢\nè‡ªåˆ†ã®è€ƒãˆã«å›ºåŸ·ã—ã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸"
    },
    "Yellow": {
        "name": "ã‚¤ã‚¨ãƒ­ãƒ¼ (Y)",
        "meaning": "è«–ç†ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢ãƒ»çŸ¥è­˜",
        "positive": "é ­ã®å›è»¢ãŒé€Ÿãã€çŸ¥è­˜è±Šå¯Œã§æ•™ãˆã‚‹ã®ãŒå¾—æ„ã§ã™ã€‚ç‹¬è‡ªã®ãƒ¦ãƒ¼ãƒ¢ã‚¢ã§å‘¨å›²ã‚’æ˜ã‚‹ãã—ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘èƒƒç—›ãƒ»æ€è€ƒåœæ­¢\nè€ƒãˆã™ãã¦èƒƒãŒç—›ããªã£ãŸã‚Šã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘è‡ªå·±ä¸­å¿ƒçš„ãƒ»æ‰¹åˆ¤\nç†å±ˆã£ã½ããªã‚Šã€ç›¸æ‰‹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ãŠç¬‘ã„ã‚’è¦‹ã‚‹ã€è¶£å‘³ã«æ²¡é ­"
    },
    "Lime": {
        "name": "ãƒ©ã‚¤ãƒ ã‚°ãƒªãƒ¼ãƒ³ (L)",
        "meaning": "å¥³æ€§æ€§ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»æ°—é…ã‚Š",
        "positive": "æŸ”ã‚‰ã‹ã„ç‰©è…°ã§å‘¨å›²ã‚’å·»ãè¾¼ã‚€åŠ›ãŒã‚ã‚Šã¾ã™ã€‚çœŸã®å„ªã—ã•ã¨å¼·ã•ã‚’å…¼ã­å‚™ãˆãŸãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘éå°è©•ä¾¡ãƒ»å‘ä¸‹\nè‡ªåˆ†ã‚’å°ã•ãè¦‹ç©ã‚‚ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ¯”è¼ƒãƒ»ç«¶äº‰å¿ƒ\näººã¨è‡ªåˆ†ã‚’æ¯”ã¹ã¦è½ã¡è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ãƒ¢ãƒ¼ãƒ„ã‚¡ãƒ«ãƒˆã‚’è´ãã€ç·‘ã®ä¸­ã¸è¡Œã"
    },
    "Green": {
        "name": "ã‚°ãƒªãƒ¼ãƒ³ (E)",
        "meaning": "å”èª¿ãƒ»å¹³å’Œãƒ»å‚¾è´",
        "positive": "èãä¸Šæ‰‹ã§ã€ä¸€ç·’ã«ã„ã‚‹ã ã‘ã§ç›¸æ‰‹ã‚’ç™’ã‚„ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚èª¿å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ‹’çµ¶ãƒ»å¿ƒã®å£\nè¨€ã„ãŸã„ã“ã¨ãŒè¨€ãˆãšã€å¿ƒã«å£ã‚’ä½œã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘ãŠç¯€ä»‹ãƒ»å…«æ–¹ç¾äºº\nç›¸æ‰‹ã«åˆã‚ã›ã™ãã¦ç–²ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å‘¼å¸æ³•ã€æ£®æ—æµ´"
    },
    "Aqua": {
        "name": "ã‚¢ã‚¯ã‚¢ãƒ–ãƒ«ãƒ¼ (A)",
        "meaning": "å‰µé€ ãƒ»åŒèª¿ãƒ»è¡¨ç¾",
        "positive": "èŠ¸è¡“çš„ãªæ„Ÿæ€§ã‚’æŒã¡ã€è¨€è‘‰ã«ã—ãªãã¦ã‚‚ç›¸æ‰‹ã®æ°—æŒã¡ã‚’å¯Ÿã™ã‚‹å…±æ„ŸåŠ›ãŒã‚ã‚Šã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç©ºæ°—ãŒèª­ã‚ãªã„\nå‘¨ã‚Šã®ç›®ãŒæ°—ã«ãªã‚Šã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘ä»–äººè»¸ãƒ»åŒåŒ–\nç›¸æ‰‹ã®æ„Ÿæƒ…ã‚’è‡ªåˆ†ã®ã“ã¨ã®ã‚ˆã†ã«æ„Ÿã˜ã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "æ­Œã€çµµç”»ã€å¡—ã‚Šçµµãªã©ã®è¡¨ç¾"
    },
    "Blue": {
        "name": "ãƒ–ãƒ«ãƒ¼ (B)",
        "meaning": "ä¼é”ãƒ»è²¬ä»»ãƒ»å†·é™",
        "positive": "å†·é™æ²ˆç€ã§ã€ç‰©äº‹ã‚’å®Œç’§ã«ã“ãªã™å®Ÿå‹™èƒ½åŠ›ãŒã‚ã‚Šã¾ã™ã€‚è¨€è‘‰ã§ä¼ãˆã‚‹åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘å®Œç’§ä¸»ç¾©ãƒ»é–‰é–\nã€Œã€œã›ã­ã°ãªã‚‰ãªã„ã€ã¨æ€ã„è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ±ºã‚ã¤ã‘ãƒ»å›ºå®šè¦³å¿µ\nè‡ªåˆ†ã®æ­£ã—ã•ã‚’ç›¸æ‰‹ã«æŠ¼ã—ä»˜ã‘ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å†™çµŒã€åº§ç¦…ã€æ–‡ç« ã‚’æ›¸ã"
    },
    "Navy": {
        "name": "ãƒã‚¤ãƒ“ãƒ¼ãƒ–ãƒ«ãƒ¼ (N)",
        "meaning": "ç›´æ„Ÿãƒ»åˆ†æãƒ»æœ¬è³ª",
        "positive": "ç‰©äº‹ã®æœ¬è³ªã‚’è¦‹æŠœãæ´å¯ŸåŠ›ãŒã‚ã‚Šã¾ã™ã€‚å®‡å®™æ„è­˜ã¨ç¹‹ãŒã‚Šã€ç›´æ„Ÿçš„ã«ç­”ãˆã‚’å°ãå‡ºã—ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ‰¹åˆ¤ãƒ»å­¤ç‹¬\nå°†æ¥ã®ãƒ“ã‚¸ãƒ§ãƒ³ãŒè¦‹ãˆãšã€é–‰å¡æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ¨©å¨ä¸»ç¾©ãƒ»ãƒªã‚¹ã‚¯å›é¿\nå¤±æ•—ã‚’æã‚Œã™ãã¦å‹•ã‘ãªããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ç‘æƒ³ã€ä½•ã‹ã«æ²¡é ­ãƒ»é›†ä¸­"
    },
    "Violet": {
        "name": "ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆ (V)",
        "meaning": "å¤‰å®¹ãƒ»çµ±åˆãƒ»æ…ˆæ‚²",
        "positive": "å¯¾ç«‹ã™ã‚‹ã‚‚ã®ã‚’çµ±åˆã—ã€ç™’ã‚„ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ãªæ„Ÿæ€§ãŒé«˜ãã€å¥‰ä»•ã®ç²¾ç¥ã‚’æŒã¡ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘å„ªæŸ”ä¸æ–­ãƒ»é€ƒé¿\nç¾çŠ¶ã‹ã‚‰é€ƒã’å‡ºã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘é¸æ°‘æ„è­˜ãƒ»ã‚¨ã‚´\nã€Œè‡ªåˆ†ã¯ç‰¹åˆ¥ã ã€ã¨ã„ã†æ„è­˜ãŒå¼·ããªã‚Šã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ç¥ç¤¾ä»é–£ã€å¥‰ä»•æ´»å‹•ã€ç‘æƒ³"
    },
    "Magenta": {
        "name": "ãƒã‚¼ãƒ³ã‚¿ãƒ”ãƒ³ã‚¯ (M)",
        "meaning": "ç„¡å„Ÿã®æ„›ãƒ»åšæ„›",
        "positive": "è¦‹è¿”ã‚Šã‚’æ±‚ã‚ãªã„å¤§ããªæ„›ã§ã€ã™ã¹ã¦ã‚’åŒ…ã¿è¾¼ã‚€åŠ›ãŒã‚ã‚Šã¾ã™ã€‚åœ°çƒè¦æ¨¡ã®è¦–ç‚¹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ„›ã®æ¯æ¸‡ãƒ»å­¤ç‹¬\nã€Œèª°ã«ã‚‚æ„›ã•ã‚Œã¦ã„ãªã„ã€ã¨æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘è¦‹è¿”ã‚Šæ¬²æ±‚\nã€Œã—ã¦ã‚ã’ãŸã®ã«ã€ã¨ã„ã†æ°—æŒã¡ãŒå‡ºã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å‹Ÿé‡‘ã€ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã€æ„Ÿè¬"
    }
}

# ---------------------------------------------------------
# 2. ç”»åƒè§£æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆOpenCVï¼‰ - ç²¾åº¦å‘ä¸Šç‰ˆ
# ---------------------------------------------------------
def analyze_graph_colors(image, debug=False):
    # ç”»åƒã®å‰å‡¦ç†
    img_array = np.array(image)
    if img_array.ndim == 2:
        img_array = cv2.cvtColor(img_array, cv2.COLOR_GRAY2BGR)
    elif img_array.shape[2] == 4:
        img_array = cv2.cvtColor(img_array, cv2.COLOR_RGBA2BGR)
        
    img_cv = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)
    hsv = cv2.cvtColor(img_cv, cv2.COLOR_BGR2HSV)
    
    color_counts = {}
    
    # ---------------------------------------------------------
    # ã€é‡è¦ã€‘è‰²ã®åˆ¤å®šåŸºæº–ï¼ˆHSVç¯„å›²ï¼‰ã®å³æ ¼åŒ–
    # èƒŒæ™¯ï¼ˆé»’ãƒ»æ¿ƒã„ç´ºï¼‰ã‚’æ‹¾ã‚ãªã„ã‚ˆã†ã«ã€å½©åº¦(S)ã¨æ˜åº¦(V)ã®ä¸‹é™ã‚’å¼•ãä¸Šã’
    # ä¸‹é™å€¤: [è‰²ç›¸(0-180), å½©åº¦(0-255), æ˜åº¦(0-255)]
    # ---------------------------------------------------------
    definitions = {
        # èµ¤: æ˜åº¦ã‚’å°‘ã—ä¸‹ã’ã¦ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŒã€æš—ã™ããªã„ã‚ˆã†ã«
        "Red":     ([0, 100, 100], [7, 255, 255]),      
        "Red2":    ([175, 100, 100], [180, 255, 255]),
        
        # ã‚³ãƒ¼ãƒ©ãƒ«ã€œã‚ªãƒ¬ãƒ³ã‚¸ã€œã‚´ãƒ¼ãƒ«ãƒ‰ã¯æ˜ã‚‹ã„ã®ã§æ˜åº¦é«˜ã‚è¨­å®š
        "Coral":   ([7, 100, 100], [15, 255, 255]),     
        "Orange":  ([15, 100, 100], [25, 255, 255]),    
        "Gold":    ([25, 100, 100], [30, 255, 255]),
        "Yellow":  ([30, 80, 100], [35, 255, 255]),     # é»„è‰²ã¯ç™½é£›ã³ã—ã‚„ã™ã„ã®ã§å½©åº¦ä¸‹é™ã‚’å°‘ã—ç”˜ã
        
        # ç·‘ç³»
        "Lime":    ([35, 80, 100], [50, 255, 255]),     
        "Green":   ([50, 80, 100], [75, 255, 255]),     
        
        # ã€é‡è¦ã€‘é’ç³»ã®ä¿®æ­£ï¼šèƒŒæ™¯ã¨æ··ã–ã‚‰ãªã„ã‚ˆã†ã€æ˜åº¦(V)ã¨å½©åº¦(S)ã®ä¸‹é™ã‚’é«˜ãè¨­å®š
        "Aqua":    ([75, 120, 120], [95, 255, 255]),    
        "Blue":    ([95, 150, 120], [115, 255, 255]),   # å½©åº¦150ä»¥ä¸Šã€æ˜åº¦120ä»¥ä¸Šå¿…é ˆ
        "Navy":    ([115, 150, 120], [135, 255, 255]),  # ã“ã“ãŒä¸€ç•ªèƒŒæ™¯ã¨è¢«ã‚Šã‚„ã™ã„
        
        # ç´«ãƒ»ãƒ”ãƒ³ã‚¯
        "Violet":  ([135, 80, 100], [155, 255, 255]),   
        "Magenta": ([155, 80, 100], [175, 255, 255]),   
    }

    total_pixels = 0
    
    # ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
    if debug:
        st.markdown("### ğŸ” æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ï¼šè‰²ã®æŠ½å‡ºçŠ¶æ³")
        st.caption("èƒŒæ™¯ãŒé»’ãã€ã‚°ãƒ©ãƒ•ã®éƒ¨åˆ†ã ã‘ãŒç™½ãå…‰ã£ã¦ã„ã‚Œã°æ­£å¸¸ã§ã™ã€‚èƒŒæ™¯ãŒç™½ããªã£ã¦ã„ãŸã‚‰èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚")
    
    cols = st.columns(4) if debug else None
    col_idx = 0

    for color_name, (lower, upper) in definitions.items():
        # ãƒã‚¹ã‚¯ä½œæˆ
        mask = cv2.inRange(hsv, np.array(lower), np.array(upper))
        count = cv2.countNonZero(mask)
        
        # Red2ã¯Redã«çµ±åˆ
        target_name = "Red" if color_name == "Red2" else color_name
        
        # æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ï¼šèªè­˜ã—ãŸéƒ¨åˆ†ã‚’ç”»åƒã§è¡¨ç¤º
        if debug:
            # å®Ÿéš›ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒ”ã‚¯ã‚»ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
            if count > 0:
                with cols[col_idx % 4]:
                    st.image(mask, caption=f"{color_name} ({count}px)", use_column_width=True)
                    col_idx += 1

        if target_name in color_counts:
            color_counts[target_name] += count
        else:
            color_counts[target_name] = count
            
        if color_name != "Red2":
             total_pixels += count

    results = []
    
    # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£: èƒŒæ™¯ãŒå«ã¾ã‚Œã¦ã„ãªã„å‰æã§è¨ˆç®—
    # ãŸã ã—ã€ãƒã‚¤ã‚ºï¼ˆæ¥µç«¯ã«å°‘ãªã„ãƒ”ã‚¯ã‚»ãƒ«ï¼‰ã¯é™¤å¤–ã™ã‚‹
    if total_pixels > 0:
        for name, count in color_counts.items():
            percentage = (count / total_pixels) * 100
            # ã‚°ãƒ©ãƒ•ã¨ã—ã¦è¦–èªã§ãã‚‹ãƒ¬ãƒ™ãƒ«ï¼ˆå…¨ä½“ã®2%ä»¥ä¸Šï¼‰ã®ã¿æ¡ç”¨
            # ã“ã‚Œã«ã‚ˆã‚Šã€èƒŒæ™¯ã®èª¤æ¤œå‡ºãƒã‚¤ã‚ºã‚’ã‚«ãƒƒãƒˆ
            if percentage > 2.0: 
                results.append((name, percentage))
            
    results.sort(key=lambda x: x[1], reverse=True)
    return results

# ---------------------------------------------------------
# 3. ã‚¢ãƒ—ãƒªç”»é¢æ§‹æˆ
# ---------------------------------------------------------
st.title("ğŸ¤ QTV å£°è§£æãƒ»è¨ºæ–­ã‚¢ãƒ—ãƒª")
st.write("è§£æã—ãŸã„ã‚°ãƒ©ãƒ•ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
st.sidebar.header("è¨­å®š")
debug_mode = st.sidebar.checkbox("æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ (è‰²ã®èªè­˜çŠ¶æ³ã‚’è¦‹ã‚‹)", value=False)

analysis_mode = st.radio(
    "ã©ã®æ³¢å½¢ã‚’è¨ºæ–­ã—ã¾ã™ã‹ï¼Ÿ",
    ("V1 (é¡•åœ¨æ„è­˜ãƒ»å¤–å‘ãã®è‡ªåˆ†)", "V2 (ä¸‹æ„è­˜ãƒ»æ€è€ƒã®ç™–)", "V3 (æ½œåœ¨æ„è­˜ãƒ»æœ¬è³ª)")
)

target_file = st.file_uploader("ãƒ•ã‚©ãƒ«ãƒ€ã¾ãŸã¯ãƒ•ã‚©ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ", type=['jpg', 'png', 'jpeg'])

if target_file is not None:
    image = Image.open(target_file)
    st.image(image, caption='è§£æå¯¾è±¡ã®ç”»åƒ', use_column_width=True)
    
    if st.button("è¨ºæ–­é–‹å§‹"):
        with st.spinner('è§£æä¸­...12è‰²ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...'):
            results = analyze_graph_colors(image, debug=debug_mode)
            
            if not results:
                st.error("æœ‰åŠ¹ãªè‰²ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚°ãƒ©ãƒ•éƒ¨åˆ†ã‚’æ‹¡å¤§ã—ã¦æ’®å½±ã™ã‚‹ã‹ã€ç…§æ˜ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚")
            else:
                st.success("è§£æå®Œäº†ï¼")
                
                # -------------------------------------------------
                # çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢
                # -------------------------------------------------
                
                # 1ä½ã®è‰²ã‚’è¡¨ç¤º
                top_color, top_score = results[0]
                if top_color in COLOR_DB:
                    data = COLOR_DB[top_color]
                    
                    st.markdown(f"## ğŸ‘‘ ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼š{data['name']}")
                    st.markdown(f"### ã‚¨ãƒãƒ«ã‚®ãƒ¼å‰²åˆ: **{top_score:.1f}%**")
                    
                    st.info(f"**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {data['meaning']}**")
                    st.write(data['positive'])
                    
                    with st.expander(f"âš ï¸ {data['name']} ã®èª²é¡Œã¨å‡¦æ–¹ç®‹", expanded=True):
                        st.warning(data['low_msg'])
                        st.markdown(f"**ğŸ’Š ãŠã™ã™ã‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {data['prescription']}**")

                st.markdown("---")
                st.markdown("### ğŸ“Š å…¨ä½“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒãƒ©ãƒ³ã‚¹")
                
                for color_name, score in results:
                    if color_name in COLOR_DB:
                        d = COLOR_DB[color_name]
                        st.write(f"**{d['name']}**: {score:.1f}%")
                        st.progress(min(int(score), 100))
                        
    st.markdown("---")
    st.caption("ç›£ä¿®: ã‚¯ã‚©ãƒ³ã‚¿ãƒ ãƒ´ã‚©ã‚¤ã‚¹ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ èªå®šã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼")
