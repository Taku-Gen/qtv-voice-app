import streamlit as st
import cv2
import numpy as np
from PIL import Image

# ---------------------------------------------------------
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã12è‰²ã®å®šç¾©ï¼‰
# ---------------------------------------------------------
COLOR_DB = {
    "Red": {
        "name": "ãƒ¬ãƒƒãƒ‰ (R)",
        "meaning": "è¡Œå‹•åŠ›ãƒ»æƒ…ç†±ãƒ»çµŒå–¶æ„Ÿè¦šãƒ»ç¾å ´å¯¾å¿œèƒ½åŠ›",
        "positive": "ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æº€ã¡æº¢ã‚Œã€ç¾å®Ÿã‚’å‹•ã‹ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè»½ãã€ç¾©ç†å …ã„ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç„¡æ°—åŠ›ãƒ»ç¾å®Ÿé€ƒé¿\nçµŒæ¸ˆçš„ãªä¸å®‰ã‚„ã€åœ°ã«è¶³ãŒã¤ã„ã¦ã„ãªã„æ„Ÿè¦šãŒã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã‚„ã‚‹æ°—ãŒå‡ºãªã„æ™‚ã¯ã€ç„¡ç†ã«å‹•ã“ã†ã¨ã›ãšèº«ä½“ã‚’æ¸©ã‚ã¾ã—ã‚‡ã†ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘æ€’ã‚Šãƒ»å¼·å¼•\nã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¼·ã™ãã¦ã€æ”»æ’ƒçš„ã«ãªã£ãŸã‚Šã€æ­¢ã¾ã‚‹ã“ã¨ã«ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "é‹å‹•ã€æ•£æ­©ã€ãƒˆã‚¤ãƒ¬æƒé™¤ã€é›‘å·¾ãŒã‘"
    },
    "Coral": {
        "name": "ã‚³ãƒ¼ãƒ©ãƒ« (C)",
        "meaning": "æœ¬èƒ½ãƒ»æ¯æ€§ãƒ»ç¹Šç´°ã•ãƒ»ç›´æ„Ÿ",
        "positive": "ç›´æ„Ÿã‚„èº«ä½“æ„Ÿè¦šãŒé‹­ãã€å ´ã®ç©ºæ°—ã‚’è‚Œã§æ„Ÿã˜ã‚‹åŠ›ãŒã‚ã‚Šã¾ã™ã€‚äººã‚’è‚²ã¦ã‚‹æ¯æ€§ã‚„å„ªã—ã•ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç¥çµŒéæ•ãƒ»ä¾å­˜\nè‡ªåˆ†ã®å¼±ã•ã‚’å‡ºã›ãšã€ç›¸æ‰‹ã«å°½ãã—ã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿå ±ã‚ã‚Œãªã„æ€ã„ã‚’æŠ±ãˆã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»è‡ªå®¶ä¸­æ¯’\néæ•ã«ãªã‚Šã™ãã¦ã€è‡ªåˆ†ã®å†…å´ã«æ¯’ã‚’æºœã‚è¾¼ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
        "prescription": "å²©ç›¤æµ´ã€ãƒ¨ã‚¬ã€æ°—åŠŸã€èº«ä½“ã‚’æ¸©ã‚ã‚‹"
    },
    "Orange": {
        "name": "ã‚ªãƒ¬ãƒ³ã‚¸ (O)",
        "meaning": "æ„Ÿæƒ…ãƒ»ç¾æ„è­˜ãƒ»é£Ÿãƒ»äº”æ„Ÿ",
        "positive": "äº”æ„ŸãŒé‹­ãã€äººç”Ÿã‚’æ¥½ã—ã‚€é”äººã§ã™ã€‚ç¾å‘³ã—ã„ã‚‚ã®ã‚„ç¾ã—ã„ã‚‚ã®ã«æ„Ÿå‹•ã™ã‚‹å¿ƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ„Ÿæƒ…ã®æŠ‘åœ§ãƒ»ä¸æ„Ÿç—‡\nãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹æ°—æŒã¡ã‚’å¿˜ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿæˆ‘æ…¢ã‚„ã‚·ãƒ§ãƒƒã‚¯ã§æ„Ÿæƒ…ã«è“‹ã‚’ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘æ„Ÿæƒ…çš„ãƒ»åˆºæ¿€ä¸­æ¯’\nå¤–ã‹ã‚‰ã®åˆºæ¿€ï¼ˆè²·ã„ç‰©ã‚„é£Ÿï¼‰ã§æº€ãŸãã†ã¨ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿæ„Ÿæƒ…ã®èµ·ä¼ãŒæ¿€ã—ããªã£ã¦ã„ã¾ã™ã€‚",
        "prescription": "ãƒ€ãƒ³ã‚¹ã€ãƒãƒƒã‚µãƒ¼ã‚¸ã€æ¸©æ³‰ã€ç¾å‘³ã—ã„ã‚‚ã®ã‚’å‘³ã‚ã†"
    },
    "Gold": {
        "name": "ã‚´ãƒ¼ãƒ«ãƒ‰ (G)",
        "meaning": "ä¿¡å¿µãƒ»ã‚«ãƒªã‚¹ãƒãƒ»ä¸­å¿ƒãƒ»è‡ªå·±ã®ä¾¡å€¤",
        "positive": "æºã‚‹ããªã„ä¿¡å¿µã¨è‡ªåˆ†è»¸ã‚’æŒã£ã¦ã„ã¾ã™ã€‚çµ„ç¹”ã®ä¸­å¿ƒäººç‰©ã¨ã—ã¦ã€å­˜åœ¨æ„Ÿã ã‘ã§äººã‚’æƒ¹ãã¤ã‘ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ä¸å®‰ãƒ»è‡ªä¿¡å–ªå¤±\nã€Œè‡ªåˆ†ã«ã¯ä¾¡å€¤ãŒãªã„ã€ã¨æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿæ ¹æ‹ ã®ãªã„ä¸å®‰ã«è¥²ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘é ‘å›ºãƒ»å‚²æ…¢\nè‡ªåˆ†ã®è€ƒãˆã«å›ºåŸ·ã—ã™ãã¦ã€å‘¨ã‚Šã®æ„è¦‹ã‚’å—ã‘å…¥ã‚Œã‚‰ã‚Œãªããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªåˆ†ã¸ã®å®£è¨€ï¼‰ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹"
    },
    "Yellow": {
        "name": "ã‚¤ã‚¨ãƒ­ãƒ¼ (Y)",
        "meaning": "è«–ç†ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢ãƒ»å€‹ãƒ»çŸ¥è­˜",
        "positive": "é ­ã®å›è»¢ãŒé€Ÿãã€çŸ¥è­˜è±Šå¯Œã§æ•™ãˆã‚‹ã®ãŒå¾—æ„ã§ã™ã€‚ç‹¬è‡ªã®ãƒ¦ãƒ¼ãƒ¢ã‚¢ã§å‘¨å›²ã‚’æ˜ã‚‹ãã—ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘èƒƒç—›ãƒ»æ€è€ƒåœæ­¢\nè€ƒãˆã™ãã¦èƒƒãŒç—›ããªã£ãŸã‚Šã€ã©ã†ã—ã¦ã„ã„ã‹åˆ†ã‹ã‚‰ãšæ··ä¹±ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘è‡ªå·±ä¸­å¿ƒçš„ãƒ»æ‰¹åˆ¤\nç†å±ˆã£ã½ããªã‚Šã€ç›¸æ‰‹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ãŠç¬‘ã„ã‚’è¦‹ã‚‹ã€è¶£å‘³ã«æ²¡é ­ã™ã‚‹ã€ç¬‘ã†ã“ã¨"
    },
    "Lime": {
        "name": "ãƒ©ã‚¤ãƒ  (L)",
        "meaning": "å¥³æ€§æ€§ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»æ°—é…ã‚Šãƒ»æ–°ã—ã„é¢¨",
        "positive": "æŸ”ã‚‰ã‹ã„ç‰©è…°ã§å‘¨å›²ã‚’å·»ãè¾¼ã‚€åŠ›ãŒã‚ã‚Šã¾ã™ã€‚çœŸã®å„ªã—ã•ã¨å¼·ã•ã‚’å…¼ã­å‚™ãˆãŸãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘éå°è©•ä¾¡ãƒ»å‘ä¸‹\néå»ã®å‚·ã¤ã„ãŸçµŒé¨“ã‹ã‚‰ã€è‡ªåˆ†ã‚’å°ã•ãè¦‹ç©ã‚‚ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ¯”è¼ƒãƒ»ç«¶äº‰å¿ƒ\näººã¨è‡ªåˆ†ã‚’æ¯”ã¹ã¦è½ã¡è¾¼ã‚“ã ã‚Šã€å‹ã¡è² ã‘ã«ã“ã ã‚ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ãƒ¢ãƒ¼ãƒ„ã‚¡ãƒ«ãƒˆã‚’è´ãã€ç·‘ã®ä¸­ã«è¡Œã"
    },
    "Green": {
        "name": "ã‚°ãƒªãƒ¼ãƒ³ (E)",
        "meaning": "å”èª¿ãƒ»å¹³å’Œãƒ»å‚¾è´ãƒ»ãƒãƒ©ãƒ³ã‚¹",
        "positive": "èãä¸Šæ‰‹ã§ã€ä¸€ç·’ã«ã„ã‚‹ã ã‘ã§ç›¸æ‰‹ã‚’ç™’ã‚„ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚èª¿å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ‹’çµ¶ãƒ»å¿ƒã®å£\nè¨€ã„ãŸã„ã“ã¨ãŒè¨€ãˆãšã€å¿ƒã«å£ã‚’ä½œã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿå¤‰åŒ–ã‚’æã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘ãŠç¯€ä»‹ãƒ»å…«æ–¹ç¾äºº\nç›¸æ‰‹ã«åˆã‚ã›ã™ãã¦ç–²ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿäººã®é ˜åŸŸã«è¸ã¿è¾¼ã¿ã™ãã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "prescription": "å‘¼å¸æ³•ã€æ£®æ—æµ´ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹éŸ³æ¥½"
    },
    "Aqua": {
        "name": "ã‚¢ã‚¯ã‚¢ (A)",
        "meaning": "å‰µé€ ãƒ»åŒèª¿ãƒ»è¡¨ç¾ãƒ»èŠ¸è¡“",
        "positive": "èŠ¸è¡“çš„ãªæ„Ÿæ€§ã‚’æŒã¡ã€è¨€è‘‰ã«ã—ãªãã¦ã‚‚ç›¸æ‰‹ã®æ°—æŒã¡ã‚’å¯Ÿã™ã‚‹å…±æ„ŸåŠ›ãŒã‚ã‚Šã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘ç©ºæ°—ãŒèª­ã‚ãªã„\nå‘¨ã‚Šã®ç›®ãŒæ°—ã«ãªã‚Šã™ãã¦ã€è‡ªåˆ†ã‚‰ã—ã•ã‚’å‡ºã›ã¦ã„ãªã„ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘ä»–äººè»¸ãƒ»åŒåŒ–\nç›¸æ‰‹ã®æ„Ÿæƒ…ã‚’è‡ªåˆ†ã®ã“ã¨ã®ã‚ˆã†ã«æ„Ÿã˜ã™ãã¦ã€è¾›ããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "æ­Œã†ã€çµµã‚’æãã€å¡—ã‚Šçµµãªã©ã€Œè¡¨ç¾ã€ã™ã‚‹ã“ã¨"
    },
    "Blue": {
        "name": "ãƒ–ãƒ«ãƒ¼ (B)",
        "meaning": "ä¼é”ãƒ»è²¬ä»»ãƒ»å†·é™ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›",
        "positive": "å†·é™æ²ˆç€ã§ã€ç‰©äº‹ã‚’å®Œç’§ã«ã“ãªã™å®Ÿå‹™èƒ½åŠ›ãŒã‚ã‚Šã¾ã™ã€‚è¨€è‘‰ã§ä¼ãˆã‚‹åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘å®Œç’§ä¸»ç¾©ãƒ»é–‰é–\nã€Œã€œã›ã­ã°ãªã‚‰ãªã„ã€ã¨ã„ã†æ€ã„è¾¼ã¿ã§ã€è‡ªåˆ†ã‚’ç¸›ã‚Šä»˜ã‘ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿè¨€ã„ãŸã„ã“ã¨ã‚’é£²ã¿è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ±ºã‚ã¤ã‘ãƒ»å›ºå®šè¦³å¿µ\nè‡ªåˆ†ã®æ­£ã—ã•ã‚’ç›¸æ‰‹ã«æŠ¼ã—ä»˜ã‘ã¦ã—ã¾ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å†™çµŒã€åº§ç¦…ã€æ–‡ç« ã‚’æ›¸ãã€é ­ã‚’ç©ºã£ã½ã«ã™ã‚‹"
    },
    "Navy": {
        "name": "ãƒã‚¤ãƒ“ãƒ¼ (N)",
        "meaning": "ç›´æ„Ÿãƒ»åˆ†æãƒ»æœ¬è³ªãƒ»å®‡å®™æ„è­˜",
        "positive": "ç‰©äº‹ã®æœ¬è³ªã‚’è¦‹æŠœãæ´å¯ŸåŠ›ãŒã‚ã‚Šã¾ã™ã€‚å®‡å®™æ„è­˜ã¨ç¹‹ãŒã‚Šã€ç›´æ„Ÿçš„ã«ç­”ãˆã‚’å°ãå‡ºã—ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ‰¹åˆ¤ãƒ»å­¤ç‹¬\nå°†æ¥ã®ãƒ“ã‚¸ãƒ§ãƒ³ãŒè¦‹ãˆãšã€é–‰å¡æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘æ¨©å¨ä¸»ç¾©ãƒ»ãƒªã‚¹ã‚¯å›é¿\nå¤±æ•—ã‚’æã‚Œã™ãã¦ã€é ­ã§è€ƒãˆã™ãã¦å‹•ã‘ãªããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ç‘æƒ³ã€ä½•ã‹ã«æ²¡é ­ãƒ»é›†ä¸­ã™ã‚‹ã“ã¨"
    },
    "Violet": {
        "name": "ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆ (V)",
        "meaning": "å¤‰å®¹ãƒ»çµ±åˆãƒ»æ…ˆæ‚²ãƒ»ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«",
        "positive": "å¯¾ç«‹ã™ã‚‹ã‚‚ã®ã‚’çµ±åˆã—ã€ç™’ã‚„ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ãªæ„Ÿæ€§ãŒé«˜ãã€å¥‰ä»•ã®ç²¾ç¥ã‚’æŒã¡ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘å„ªæŸ”ä¸æ–­ãƒ»é€ƒé¿\nç¾çŠ¶ã‹ã‚‰é€ƒã’å‡ºã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿè‡ªåˆ†ã«å³ã—ãã—ã™ãã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "high_msg": "ã€æ³¨æ„ã€‘é¸æ°‘æ„è­˜ãƒ»ã‚¨ã‚´\nã€Œè‡ªåˆ†ã¯ç‰¹åˆ¥ã ã€ã¨ã„ã†æ„è­˜ãŒå¼·ããªã‚Šã™ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "ç¥ç¤¾ä»é–£ã¸ã®å‚æ‹ã€å¥‰ä»•æ´»å‹•ã€ç‘æƒ³"
    },
    "Magenta": {
        "name": "ãƒã‚¼ãƒ³ã‚¿ (M)",
        "meaning": "ç„¡å„Ÿã®æ„›ãƒ»åšæ„›ãƒ»å®Œäº†",
        "positive": "è¦‹è¿”ã‚Šã‚’æ±‚ã‚ãªã„å¤§ããªæ„›ã§ã€ã™ã¹ã¦ã‚’åŒ…ã¿è¾¼ã‚€åŠ›ãŒã‚ã‚Šã¾ã™ã€‚åœ°çƒè¦æ¨¡ã®è¦–ç‚¹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
        "low_msg": "ã€èª²é¡Œã€‘æ„›ã®æ¯æ¸‡ãƒ»å­¤ç‹¬\nã€Œèª°ã«ã‚‚æ„›ã•ã‚Œã¦ã„ãªã„ã€ã€Œèªã‚ã‚‰ã‚Œã¦ã„ãªã„ã€ã¨ã„ã†å­¤ç‹¬æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "high_msg": "ã€æ³¨æ„ã€‘è¦‹è¿”ã‚Šæ¬²æ±‚\nã€Œã—ã¦ã‚ã’ãŸã®ã«ã€ã¨ã„ã†æ©ç€ã›ãŒã¾ã—ã„æ°—æŒã¡ãŒå‡ºã¦ãã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ",
        "prescription": "å‹Ÿé‡‘ã€ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã€æ„Ÿè¬ã‚’ä¼ãˆã‚‹"
    }
}

# ---------------------------------------------------------
# 2. ç”»åƒè§£æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆOpenCVï¼‰
# ---------------------------------------------------------
def analyze_graph_colors(image):
    # PILç”»åƒã‚’OpenCVå½¢å¼ã«å¤‰æ›
    img_cv = cv2.cvtColor(np.array(image), cv2.COLOR_RGB2BGR)
    hsv = cv2.cvtColor(img_cv, cv2.COLOR_BGR2HSV)
    
    # è§£æçµæœã‚’æ ¼ç´ã™ã‚‹è¾æ›¸
    color_counts = {}
    
    # 12è‰²ã®å®šç¾©ï¼ˆHSVç¯„å›²ï¼‰
    # â€»ç”»åƒè§£æç”¨ã«ç¯„å›²ã‚’èª¿æ•´æ¸ˆã¿
    definitions = {
        "Red":     ([0, 100, 100], [10, 255, 255]),      # èµ¤
        "Red2":    ([170, 100, 100], [180, 255, 255]),   # èµ¤ï¼ˆè‰²ç›¸ç’°ã®åå¯¾å´ï¼‰
        "Coral":   ([10, 100, 100], [20, 255, 255]),     # ã‚³ãƒ¼ãƒ©ãƒ«ï¼ˆæœ±è‰²ï¼‰
        "Orange":  ([20, 100, 100], [30, 255, 255]),     # ã‚ªãƒ¬ãƒ³ã‚¸
        "Gold":    ([30, 100, 100], [45, 255, 255]),     # ã‚´ãƒ¼ãƒ«ãƒ‰/æ¿ƒã„é»„
        "Yellow":  ([25, 100, 100], [35, 255, 255]),     # æ˜ã‚‹ã„é»„è‰²
        "Lime":    ([45, 100, 100], [65, 255, 255]),     # ãƒ©ã‚¤ãƒ 
        "Green":   ([65, 100, 100], [85, 255, 255]),     # ç·‘
        "Aqua":    ([85, 100, 100], [105, 255, 255]),    # æ°´è‰²
        "Blue":    ([105, 100, 100], [130, 255, 255]),   # é’
        "Navy":    ([130, 100, 100], [155, 255, 255]),   # ç¾¤é’ãƒ»ãƒã‚¤ãƒ“ãƒ¼
        "Violet":  ([125, 50, 50], [150, 255, 255]),     # ç´«ï¼ˆç¯„å›²èª¿æ•´ï¼‰
        "Magenta": ([150, 100, 100], [170, 255, 255]),   # ãƒã‚¼ãƒ³ã‚¿
    }

    total_pixels = 0
    
    for color_name, (lower, upper) in definitions.items():
        # æŒ‡å®šã—ãŸè‰²ã®ç¯„å›²ã®ã¿ã‚’æŠ½å‡ºï¼ˆãƒã‚¹ã‚¯ä½œæˆï¼‰
        mask = cv2.inRange(hsv, np.array(lower), np.array(upper))
        # ãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        count = cv2.countNonZero(mask)
        
        # Red2ã¯Redã«åˆç®—
        if color_name == "Red2":
            if "Red" in color_counts:
                color_counts["Red"] += count
                total_pixels += count
        else:
            color_counts[color_name] = count
            total_pixels += count

    # å‰²åˆï¼ˆ%ï¼‰ã«å¤‰æ›
    results = []
    if total_pixels > 0:
        for name, count in color_counts.items():
            percentage = (count / total_pixels) * 100
            # Red2ä»¥å¤–ã®æœ‰åŠ¹ãªè‰²ã®ã¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
            if name != "Red2":
                results.append((name, percentage))
            
    # å‰²åˆãŒé«˜ã„é †ã«ä¸¦ã³æ›¿ãˆ
    results.sort(key=lambda x: x[1], reverse=True)
    return results

# ---------------------------------------------------------
# 3. ã‚¢ãƒ—ãƒªç”»é¢æ§‹æˆ (Streamlit)
# ---------------------------------------------------------
st.title("ğŸ¤ QTV å£°è§£æãƒ»è¨ºæ–­ã‚¢ãƒ—ãƒª")
st.write("ã‚°ãƒ©ãƒ•ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯æ’®å½±ã—ã¦ãã ã•ã„ã€‚")

# V1, V2, V3 ã®é¸æŠ
analysis_mode = st.radio(
    "ã©ã®æ³¢å½¢ã‚’è¨ºæ–­ã—ã¾ã™ã‹ï¼Ÿ",
    ("V1 (é¡•åœ¨æ„è­˜ãƒ»å¤–å‘ãã®è‡ªåˆ†)", "V2 (ä¸‹æ„è­˜ãƒ»æ€è€ƒã®ç™–)", "V3 (æ½œåœ¨æ„è­˜ãƒ»æœ¬è³ª)")
)
st.caption("â€»V1ã¯ç¤¾ä¼šçš„ãªæŒ¯ã‚‹èˆã„ã€V2ã¯ç¿’æ…£ã‚„ç™–ã€V3ã¯æœ¬æ¥ã®è‡ªåˆ†ã‚’è¡¨ã—ã¾ã™ã€‚")

# ã‚«ãƒ¡ãƒ©å…¥åŠ› ã¾ãŸã¯ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
uploaded_file = st.file_uploader("ç”»åƒã‚’é¸æŠ", type=['jpg', 'png', 'jpeg'])
camera_file = st.camera_input("ã‚«ãƒ¡ãƒ©ã§æ’®å½±")

target_file = camera_file if camera_file is not None else uploaded_file

if target_file is not None:
    # ç”»åƒã‚’è¡¨ç¤º
    image = Image.open(target_file)
    st.image(image, caption='è§£æå¯¾è±¡ã®ã‚°ãƒ©ãƒ•', use_column_width=True)
    
    with st.spinner('è§£æä¸­...12è‰²ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...'):
        # è§£æå®Ÿè¡Œ
        results = analyze_graph_colors(image)
        
        if not results:
            st.error("æœ‰åŠ¹ãªè‰²ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚°ãƒ©ãƒ•ãŒå¤§ããå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚")
        else:
            st.success("è§£æå®Œäº†ï¼")
            
            # ä¸Šä½3è‰²ã‚’è¡¨ç¤º
            st.markdown("### ğŸ“Š æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒãƒ«ã‚®ãƒ¼ (TOP 3)")
            
            for i in range(min(3, len(results))):
                color_name, score = results[i]
                
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹è‰²ãŒã‚ã‚‹ã‹ç¢ºèª
                if color_name in COLOR_DB:
                    data = COLOR_DB[color_name]
                    
                    # 1ä½ã®è‰²ã¯å¤§ããè¡¨ç¤º
                    if i == 0:
                        st.markdown(f"## ğŸ‘‘ 1ä½ï¼š{data['name']} ({score:.1f}%)")
                        st.info(f"**ã€æœ¬è³ªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘** {data['meaning']}")
                        st.write(data['positive'])
                        
                        # èª²é¡Œã¨å‡¦æ–¹ç®‹
                        with st.expander(f"âš ï¸ {data['name']} ã®èª²é¡Œã¨å‡¦æ–¹ç®‹ã‚’è¦‹ã‚‹", expanded=True):
                            st.warning(data['low_msg'])
                            st.error(data['high_msg'])
                            st.markdown(f"### ğŸ’Š ãŠã™ã™ã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: **{data['prescription']}**")
                    
                    # 2ä½ãƒ»3ä½ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«è¡¨ç¤º
                    else:
                        st.markdown(f"**{i+1}ä½ï¼š{data['name']} ({score:.1f}%)**")
                        st.caption(data['meaning'])

    st.markdown("---")
    st.caption("ç›£ä¿®: ã‚¯ã‚©ãƒ³ã‚¿ãƒ ãƒ´ã‚©ã‚¤ã‚¹ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ èªå®šã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼")
