import streamlit as st
import cv2
import numpy as np
from PIL import Image

# ---------------------------------------------------------
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæ•™ç§‘æ›¸ã«åŸºã¥ãå®šç¾©ï¼‰
# ---------------------------------------------------------
# ã“ã“ã«PDFãƒ†ã‚­ã‚¹ãƒˆã®ç¬¬9ç« ï¼ˆP.71~82ï¼‰ã®æƒ…å ±ã‚’å®šç¾©ã—ã¾ã™
COLOR_DB = {
    "Red": {
        "name": "ãƒ¬ãƒƒãƒ‰ (R)",
        [span_4](start_span)"meaning": "è¡Œå‹•åŠ›ãƒ»æƒ…ç†±ãƒ»çµŒå–¶æ„Ÿè¦šãƒ»ç¾å ´å¯¾å¿œèƒ½åŠ›[span_4](end_span)",
        "positive": "ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æº€ã¡æº¢ã‚Œã€ç¾å®Ÿã‚’å‹•ã‹ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè»½ãã€ç¾©ç†å …ã„ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ã§ã™ã€‚",
        [span_5](start_span)"low_msg": "ã€èª²é¡Œã€‘ç„¡æ°—åŠ›ãƒ»ç¾å®Ÿé€ƒé¿\nçµŒæ¸ˆçš„ãªä¸å®‰ã‚„ã€åœ°ã«è¶³ãŒã¤ã„ã¦ã„ãªã„æ„Ÿè¦šãŒã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã‚„ã‚‹æ°—ãŒå‡ºãªã„æ™‚ã¯ã€ç„¡ç†ã«å‹•ã“ã†ã¨ã›ãšèº«ä½“ã‚’æ¸©ã‚ã¾ã—ã‚‡ã†ã€‚[span_5](end_span)",
        [span_6](start_span)"high_msg": "ã€æ³¨æ„ã€‘æ€’ã‚Šãƒ»å¼·å¼•\nã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¼·ã™ãã¦ã€æ”»æ’ƒçš„ã«ãªã£ãŸã‚Šã€æ­¢ã¾ã‚‹ã“ã¨ã«ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ[span_6](end_span)",
        [span_7](start_span)"prescription": "é‹å‹•ã€æ•£æ­©ã€ãƒˆã‚¤ãƒ¬æƒé™¤ã€é›‘å·¾ãŒã‘[span_7](end_span)"
    },
    "Gold": {
        "name": "ã‚´ãƒ¼ãƒ«ãƒ‰ (G)",
        [span_8](start_span)"meaning": "ä¿¡å¿µãƒ»ã‚«ãƒªã‚¹ãƒãƒ»ä¸­å¿ƒãƒ»è‡ªå·±ã®ä¾¡å€¤[span_8](end_span)",
        "positive": "æºã‚‹ããªã„ä¿¡å¿µã¨è‡ªåˆ†è»¸ã‚’æŒã£ã¦ã„ã¾ã™ã€‚çµ„ç¹”ã®ä¸­å¿ƒäººç‰©ã¨ã—ã¦ã€å­˜åœ¨æ„Ÿã ã‘ã§äººã‚’æƒ¹ãã¤ã‘ã¾ã™ã€‚",
        [span_9](start_span)"low_msg": "ã€èª²é¡Œã€‘ä¸å®‰ãƒ»è‡ªä¿¡å–ªå¤±\nã€Œè‡ªåˆ†ã«ã¯ä¾¡å€¤ãŒãªã„ã€ã¨æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿæ ¹æ‹ ã®ãªã„ä¸å®‰ã«è¥²ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚[span_9](end_span)",
        [span_10](start_span)"high_msg": "ã€æ³¨æ„ã€‘é ‘å›ºãƒ»å‚²æ…¢\nè‡ªåˆ†ã®è€ƒãˆã«å›ºåŸ·ã—ã™ãã¦ã€å‘¨ã‚Šã®æ„è¦‹ã‚’å—ã‘å…¥ã‚Œã‚‰ã‚Œãªããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ[span_10](end_span)",
        [span_11](start_span)"prescription": "ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªåˆ†ã¸ã®å®£è¨€ï¼‰ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹[span_11](end_span)"
    },
    "Blue": {
        "name": "ãƒ–ãƒ«ãƒ¼ (B)",
        [span_12](start_span)"meaning": "ä¼é”ãƒ»è²¬ä»»ãƒ»å†·é™ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›[span_12](end_span)",
        "positive": "å†·é™æ²ˆç€ã§ã€ç‰©äº‹ã‚’å®Œç’§ã«ã“ãªã™å®Ÿå‹™èƒ½åŠ›ãŒã‚ã‚Šã¾ã™ã€‚è¨€è‘‰ã§ä¼ãˆã‚‹åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚",
        [span_13](start_span)"low_msg": "ã€èª²é¡Œã€‘å®Œç’§ä¸»ç¾©ãƒ»é–‰é–\nã€Œã€œã›ã­ã°ãªã‚‰ãªã„ã€ã¨ã„ã†æ€ã„è¾¼ã¿ã§ã€è‡ªåˆ†ã‚’ç¸›ã‚Šä»˜ã‘ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿè¨€ã„ãŸã„ã“ã¨ã‚’é£²ã¿è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ[span_13](end_span)",
        [span_14](start_span)"high_msg": "ã€æ³¨æ„ã€‘æ±ºã‚ã¤ã‘ãƒ»å›ºå®šè¦³å¿µ\nè‡ªåˆ†ã®æ­£ã—ã•ã‚’ç›¸æ‰‹ã«æŠ¼ã—ä»˜ã‘ã¦ã—ã¾ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ[span_14](end_span)",
        [span_15](start_span)"prescription": "å†™çµŒã€åº§ç¦…ã€æ–‡ç« ã‚’æ›¸ãã€é ­ã‚’ç©ºã£ã½ã«ã™ã‚‹[span_15](end_span)"
    },
    "Green": {
        "name": "ã‚°ãƒªãƒ¼ãƒ³ (Gr)",
        [span_16](start_span)"meaning": "å”èª¿ãƒ»å¹³å’Œãƒ»å‚¾è´ãƒ»ãƒãƒ©ãƒ³ã‚¹[span_16](end_span)",
        "positive": "èãä¸Šæ‰‹ã§ã€ä¸€ç·’ã«ã„ã‚‹ã ã‘ã§ç›¸æ‰‹ã‚’ç™’ã‚„ã™åŠ›ãŒã‚ã‚Šã¾ã™ã€‚èª¿å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚",
        [span_17](start_span)"low_msg": "ã€èª²é¡Œã€‘æ‹’çµ¶ãƒ»å¿ƒã®å£\nè¨€ã„ãŸã„ã“ã¨ãŒè¨€ãˆãšã€å¿ƒã«å£ã‚’ä½œã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿå¤‰åŒ–ã‚’æã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚[span_17](end_span)",
        [span_18](start_span)"high_msg": "ã€æ³¨æ„ã€‘ãŠç¯€ä»‹ãƒ»å…«æ–¹ç¾äºº\nç›¸æ‰‹ã«åˆã‚ã›ã™ãã¦ç–²ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿäººã®é ˜åŸŸã«è¸ã¿è¾¼ã¿ã™ãã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚[span_18](end_span)",
        [span_19](start_span)"prescription": "å‘¼å¸æ³•ã€æ£®æ—æµ´ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹éŸ³æ¥½[span_19](end_span)"
    },
    # â€»å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã“ã“ã«å…¨12è‰²åˆ†ã‚’è¿½åŠ ã—ã¾ã™
}

# ---------------------------------------------------------
# 2. ç”»åƒè§£æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆOpenCVï¼‰
# ---------------------------------------------------------
def analyze_graph_colors(image):
    # PILç”»åƒã‚’OpenCVå½¢å¼ã«å¤‰æ›
    img_cv = cv2.cvtColor(np.array(image), cv2.COLOR_RGB2BGR)
    hsv = cv2.cvtColor(img_cv, cv2.COLOR_BGR2HSV)
    
    # è§£æçµæœã‚’æ ¼ç´ã™ã‚‹è¾æ›¸
    color_counts = {}
    
    # è‰²ã®å®šç¾©ï¼ˆHSVç¯„å›²ï¼‰â€»è¦èª¿æ•´ï¼šç”»åƒã®ç…§æ˜æ¡ä»¶ã«åˆã‚ã›ã¦ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦
    # ã“ã“ã§ã¯ç°¡æ˜“çš„ã« èµ¤ã€é‡‘(é»„)ã€é’ã€ç·‘ ã‚’å®šç¾©
    definitions = {
        "Red":   ([0, 100, 100], [10, 255, 255]),      # èµ¤ã®ä¸‹é™ãƒ»ä¸Šé™
        "Gold":  ([20, 100, 100], [35, 255, 255]),     # é»„/é‡‘ã®ä¸‹é™ãƒ»ä¸Šé™
        "Green": ([40, 100, 100], [80, 255, 255]),     # ç·‘ã®ä¸‹é™ãƒ»ä¸Šé™
        "Blue":  ([100, 100, 100], [140, 255, 255]),   # é’ã®ä¸‹é™ãƒ»ä¸Šé™
    }

    total_pixels = 0
    
    for color_name, (lower, upper) in definitions.items():
        # æŒ‡å®šã—ãŸè‰²ã®ç¯„å›²ã®ã¿ã‚’æŠ½å‡ºï¼ˆãƒã‚¹ã‚¯ä½œæˆï¼‰
        mask = cv2.inRange(hsv, np.array(lower), np.array(upper))
        # ãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        count = cv2.countNonZero(mask)
        color_counts[color_name] = count
        total_pixels += count

    # å‰²åˆï¼ˆ%ï¼‰ã«å¤‰æ›
    results = []
    if total_pixels > 0:
        for name, count in color_counts.items():
            percentage = (count / total_pixels) * 100
            results.append((name, percentage))
            
    # å‰²åˆãŒé«˜ã„é †ã«ä¸¦ã³æ›¿ãˆ
    results.sort(key=lambda x: x[1], reverse=True)
    return results

# ---------------------------------------------------------
# 3. ã‚¢ãƒ—ãƒªç”»é¢æ§‹æˆ (Streamlit)
# ---------------------------------------------------------
st.title("ğŸ¤ QTV å£°è§£æãƒ»è¨ºæ–­ã‚¢ãƒ—ãƒª")
st.write("ã‚°ãƒ©ãƒ•ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯æ’®å½±ã—ã¦ãã ã•ã„ã€‚")

# V1, V2, V3 ã®é¸æŠï¼ˆãƒ†ã‚­ã‚¹ãƒˆ P.100 ã€Œè§£èª¬ã®ä»•æ–¹ã€ã«åŸºã¥ãï¼‰
analysis_mode = st.radio(
    "ã©ã®æ³¢å½¢ã‚’è¨ºæ–­ã—ã¾ã™ã‹ï¼Ÿ",
    ("V1 (é¡•åœ¨æ„è­˜ãƒ»å¤–å‘ãã®è‡ªåˆ†)", "V2 (ä¸‹æ„è­˜ãƒ»æ€è€ƒã®ç™–)", "V3 (æ½œåœ¨æ„è­˜ãƒ»æœ¬è³ª)")
)
[span_20](start_span)[span_21](start_span)st.caption("â€»V1ã¯ç¤¾ä¼šçš„ãªæŒ¯ã‚‹èˆã„ã€V2ã¯ç¿’æ…£ã‚„ç™–ã€V3ã¯æœ¬æ¥ã®è‡ªåˆ†ã‚’è¡¨ã—ã¾ã™[span_20](end_span)[span_21](end_span)ã€‚")

# ã‚«ãƒ¡ãƒ©å…¥åŠ› ã¾ãŸã¯ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
uploaded_file = st.file_uploader("ç”»åƒã‚’é¸æŠ", type=['jpg', 'png', 'jpeg'])
camera_file = st.camera_input("ã‚«ãƒ¡ãƒ©ã§æ’®å½±")

target_file = camera_file if camera_file is not None else uploaded_file

if target_file is not None:
    # ç”»åƒã‚’è¡¨ç¤º
    image = Image.open(target_file)
    st.image(image, caption='è§£æå¯¾è±¡ã®ã‚°ãƒ©ãƒ•', use_column_width=True)
    
    with st.spinner('è§£æä¸­...è‰²ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...'):
        # è§£æå®Ÿè¡Œ
        results = analyze_graph_colors(image)
        
        if not results:
            st.error("æœ‰åŠ¹ãªè‰²ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚°ãƒ©ãƒ•ãŒå¤§ããå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚")
        else:
            st.success("è§£æå®Œäº†ï¼")
            
            # ä¸€ç•ªå¼·ã‹ã£ãŸè‰²ï¼ˆãƒ‰ãƒŸãƒŠãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼‰ã‚’å–å¾—
            top_color, top_score = results[0]
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
            if top_color in COLOR_DB:
                data = COLOR_DB[top_color]
                
                st.markdown(f"### ğŸ‘‘ ã‚ãªãŸã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼š{data['name']}")
                st.progress(int(top_score))
                st.write(f"è‰²ã®å¼·ã•: {top_score:.1f}%")
                
                # è¨ºæ–­çµæœè¡¨ç¤º
                st.info(f"**ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘** {data['meaning']}")
                st.write(data['positive'])
                
                # è©³ç´°ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆã‚¨ã‚­ã‚¹ãƒ‘ãƒ³ãƒ€ãƒ¼ã§é–‹é–‰ï¼‰
                with st.expander("âš ï¸ èª²é¡Œã¨æ³¨æ„ç‚¹ã‚’è¦‹ã‚‹"):
                    st.warning(data['low_msg'])
                    st.error(data['high_msg'])
                
                # å‡¦æ–¹ç®‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ P.71~82, 112 ã«åŸºã¥ãï¼‰
                st.markdown("### ğŸ’Š ä»Šæ—¥ã®å‡¦æ–¹ç®‹ (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³)")
                st.success(f"**{data['prescription']}**")
                [span_22](start_span)[span_23](start_span)st.caption("ã¾ãšã¯21æ—¥é–“ã€æ„è­˜ã—ã¦ç¶šã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚[span_22](end_span)[span_23](end_span)")
                
            else:
                st.write(f"æ¤œå‡ºã•ã‚ŒãŸè‰²: {top_color} (è©³ç´°ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²)")

    st.markdown("---")
    st.caption("ç›£ä¿®: ã‚¯ã‚©ãƒ³ã‚¿ãƒ ãƒ´ã‚©ã‚¤ã‚¹ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ èªå®šã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼")
